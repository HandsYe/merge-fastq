# 实现计划

- [x] 1. 创建项目结构和头文件定义








  - 创建所有必需的.c和.h文件
  - 在头文件中定义所有数据结构、常量和函数声明
  - 创建Makefile用于编译项目
  - _需求: 1.1, 1.2, 1.3_

- [x] 2. 实现工具模块 (utils.c/h)


  - 实现安全的内存分配函数（safe_malloc, safe_realloc）
  - 实现字符串处理函数（safe_strdup, trim_newline）
  - 实现错误处理函数（error_exit, warning_msg）
  - 实现文件操作辅助函数（file_exists, get_file_size）
  - _需求: 5.3, 5.5_

- [x] 3. 实现FASTQ解析器模块

- [x] 3.1 实现FASTQ文件读取功能


  - 实现fastq_reader_open函数，打开文件并初始化读取器
  - 实现fastq_reader_next函数，使用动态缓冲区逐行读取FASTQ记录
  - 实现fastq_reader_close函数，关闭文件并释放资源
  - _需求: 1.1, 5.1, 5.3_

- [x] 3.2 实现FASTQ格式验证功能

  - 实现fastq_record_validate函数，验证记录是否包含4行
  - 验证序列行和质量分数行长度是否一致
  - 验证序列ID行是否以@开头
  - 验证分隔符行是否以+开头
  - 在格式错误时生成详细的错误消息
  - _需求: 4.1, 4.2, 4.3_

- [x] 3.3 实现FASTQ记录内存管理

  - 实现fastq_record_free函数，释放记录占用的内存
  - 确保所有动态分配的字符串都被正确释放
  - _需求: 5.3_

- [ ]* 3.4 编写FASTQ解析器单元测试
  - 创建测试文件test_parser.c
  - 测试正确格式的FASTQ文件解析
  - 测试格式错误检测（缺少行、长度不匹配等）
  - 测试边界情况（空文件、单条记录）
  - _需求: 4.1, 4.2_


- [ ] 4. 实现ID生成器模块
- [x] 4.1 实现ID生成器初始化和配置


  - 实现id_generator_init函数，初始化生成器配置
  - 设置默认值（仪器名、运行号、流动槽ID等）
  - 初始化序列计数器
  - _需求: 2.2, 2.5_

- [x] 4.2 实现序列ID生成逻辑

  - 实现id_generator_next函数，生成符合Illumina格式的序列ID
  - 使用计数器生成递增的坐标值（tile, x_pos, y_pos）
  - 格式化ID字符串为标准格式：@仪器名:运行号:流动槽ID:泳道:tile:x:y 读段:过滤:控制位:索引
  - 确保每次调用生成唯一的ID
  - _需求: 2.1, 2.2, 2.3, 2.4_

- [x] 4.3 实现ID生成器资源释放

  - 实现id_generator_free函数，释放生成器占用的内存
  - _需求: 5.3_

- [ ]* 4.4 编写ID生成器单元测试
  - 创建测试文件test_id_generator.c
  - 测试ID格式正确性
  - 测试ID唯一性（生成多个ID并验证不重复）
  - 测试自定义参数（前缀、运行号等）
  - _需求: 2.1, 2.2, 2.3_


- [ ] 5. 实现文件合并模块
- [x] 5.1 实现FASTQ记录写入功能


  - 实现write_fastq_record函数，将记录写入输出文件
  - 使用新的序列ID替换原始ID
  - 保持序列、分隔符和质量分数行不变
  - 使用缓冲I/O提高写入效率
  - _需求: 1.2, 1.3, 5.1_

- [x] 5.2 实现文件合并主逻辑

  - 实现merge_fastq_files函数，协调整个合并过程
  - 打开输出文件进行写入
  - 遍历所有输入文件，逐个处理
  - 对每个输入文件，逐条读取记录、生成新ID、写入输出
  - 统计处理的文件数和序列数
  - 处理过程中检测并报告错误
  - _需求: 1.1, 1.2, 4.4, 5.1_

- [x] 5.3 实现处理进度和统计信息

  - 在verbose模式下输出处理进度
  - 统计总序列数和处理的文件数
  - 在处理完成后输出摘要信息
  - _需求: 4.4, 4.5_

- [x] 5.4 实现错误检测和处理

  - 检测文件打开失败
  - 检测磁盘空间不足（写入失败）
  - 检测格式错误并报告详细位置
  - 确保错误时正确清理资源
  - _需求: 1.4, 4.2, 5.4, 5.5_

- [ ]* 5.5 编写文件合并集成测试
  - 创建测试脚本run_tests.sh
  - 准备测试FASTQ文件（小文件、多文件）
  - 测试单文件处理
  - 测试多文件合并
  - 验证输出文件格式和内容正确性

  - _需求: 1.1, 1.2, 1.3_

- [ ] 6. 实现主程序和命令行接口
- [x] 6.1 实现命令行参数解析


  - 在main.c中实现参数解析逻辑
  - 支持-i/--input参数（可多次指定）
  - 支持-o/--output参数
  - 支持-p/--prefix, -r/--run-id, -f/--flowcell, -l/--lane等可选参数
  - 支持-v/--verbose, -h/--help, --version参数
  - 验证必需参数是否提供
  - _需求: 3.1, 3.2, 3.4_


- [ ] 6.2 实现帮助和版本信息
  - 实现print_usage函数，显示程序用法和参数说明
  - 实现print_version函数，显示版本信息
  - 在缺少参数或使用-h时显示帮助信息

  - _需求: 3.3, 3.4_

- [ ] 6.3 实现主程序流程控制
  - 根据命令行参数初始化ID生成器配置
  - 创建MergerConfig结构并填充参数
  - 调用merge_fastq_files执行合并
  - 处理返回的错误码
  - 输出处理摘要（文件数、序列数、输出路径）

  - 确保所有资源在退出前正确释放
  - _需求: 1.1, 1.2, 4.5, 5.3, 5.5_

- [ ] 6.4 实现参数验证
  - 验证输入文件是否存在
  - 验证输入输出文件路径不相同
  - 验证参数值的有效性（如泳道编号为正整数）
  - 在参数无效时输出错误信息
  - _需求: 3.4, 4.2_



- [ ]* 6.5 编写端到端测试
  - 测试各种命令行参数组合
  - 测试帮助和版本信息显示

  - 测试错误参数处理
  - 测试完整的合并流程
  - _需求: 3.1, 3.2, 3.3, 3.4_

- [ ] 7. 完善Makefile和编译配置
  - 完善Makefile，添加依赖关系
  - 添加clean目标清理编译产物
  - 添加test目标运行测试
  - 添加install目标（可选）
  - 确保使用-std=c99 -O2 -Wall -Wextra编译选项
  - _需求: 1.1_

- [ ]* 8. 性能测试和优化
  - 创建大型测试文件（100MB, 1GB）
  - 测试处理时间和内存使用
  - 使用valgrind检测内存泄漏
  - 根据测试结果进行性能优化（调整缓冲区大小等）
  - 验证内存使用不超过100MB
  - _需求: 1.5, 5.1, 5.2_

- [ ]* 9. 创建README文档
  - 编写README.md文件
  - 说明程序功能和用途
  - 提供编译和安装说明
  - 提供使用示例
  - 说明FASTQ格式要求
  - 列出已知限制和注意事项
  - _需求: 3.3_

- [ ]* 10. 创建示例和测试数据
  - 创建examples目录
  - 准备示例FASTQ文件
  - 创建示例脚本展示常见用法
  - 准备测试数据集用于验证
  - _需求: 1.1, 4.1_
